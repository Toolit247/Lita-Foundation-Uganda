<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin Dashboard - LITA Foundation</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    .admin-wrap { max-width: 1000px; margin: 30px auto; background: #fff; padding: 20px; border-radius: 12px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 10px; border-bottom: 1px solid #eee; text-align: left; }
    th { background: #f7f7f7; }
    .row-actions button { margin-right: 6px; }
    .two-col { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .full { grid-column: 1/-1; }
  </style>
</head>
<body>
  <div class="admin-wrap">
    <h2>Admin Dashboard</h2>
    <button class="logout-btn" id="logout">Logout</button>

    <h3>Register New Member</h3>
    <form id="addMemberForm" class="two-col">
      <input type="text" id="newFullName" placeholder="Full Name" required />
      <input type="email" id="newEmail" placeholder="Email" required />
      <input type="text" id="newPhone" placeholder="Phone" required />
      <select id="newGender" required>
        <option value="">--Select Gender--</option>
        <option>Male</option>
        <option>Female</option>
      </select>
      <input type="text" id="newLocation" placeholder="Location" required />
      <input type="text" id="newUpline" placeholder="Upline ID" required />
      <input type="text" id="newMemberId" placeholder="Member ID (manual)" required />
      <input type="password" id="newPassword" placeholder="Temp Password" required />
      <button type="submit" class="full">Register Member</button>
      <div id="addMemberMessage" class="full"></div>
    </form>

    <h3>Registered Members</h3>
    <table id="membersTable">
      <thead>
        <tr>
          <th>Member ID</th>
          <th>Full Name</th>
          <th>Email</th>
          <th>Phone</th>
          <th>Gender</th>
          <th>Location</th>
          <th>Upline</th>
          <th>Progress</th>
          <th>History</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <button id="exportCSV">Export to CSV</button>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, getDocs, addDoc, setDoc, doc, serverTimestamp, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAMnu2djtDKXMrTVKnppeCfKXRCy1KkEYk",
      authDomain: "lita-platform-bffdc.firebaseapp.com",
      projectId: "lita-platform-bffdc",
      storageBucket: "lita-platform-bffdc.appspot.com",
      messagingSenderId: "387943226211",
      appId: "1:387943226211:web:0127c409e0f880df391156"
    };

    // Main app (admin session)
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const ADMIN_EMAIL = "toolitambrosehenry@gmail.com";

    // Secondary app to create users without logging out admin
    const secondaryApp = initializeApp(firebaseConfig, "Secondary");
    const secondaryAuth = getAuth(secondaryApp);

    onAuthStateChanged(auth, (user) => {
      if (!user || user.email !== ADMIN_EMAIL) {
        window.location.href = "signin.html";
      } else {
        loadMembers();
      }
    });

    async function loadMembers() {
      const tbody = document.querySelector("#membersTable tbody");
      tbody.innerHTML = "";
      const snap = await getDocs(collection(db, "members"));
      snap.forEach((d) => {
        const data = d.data();
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${data.memberId || ""}</td>
          <td>${data.fullName || ""}</td>
          <td>${data.email || ""}</td>
          <td>${data.phone || ""}</td>
          <td>${data.gender || ""}</td>
          <td>${data.location || ""}</td>
          <td>${data.upline || ""}</td>
          <td>${data.businessProgress || "N/A"}</td>
          <td><button data-id="${d.id}" class="view-history">View</button></td>
        `;
        tbody.appendChild(tr);
      });

      // bind history buttons
      document.querySelectorAll(".view-history").forEach(btn => {
        btn.addEventListener("click", () => viewProgressHistory(btn.getAttribute("data-id")));
      });
    }

    async function viewProgressHistory(memberUid) {
      const w = window.open("", "Progress History", "width=640,height=540");
      w.document.write("<h3>Progress History</h3><ul id='historyList' style='font-family: sans-serif;'></ul>");

      const histQ = query(collection(db, "members", memberUid, "progressHistory"), orderBy("timestamp", "desc"));
      const snap = await getDocs(histQ);

      const ul = w.document.getElementById("historyList");
      snap.forEach((d) => {
        const item = d.data();
        const li = w.document.createElement("li");
        const when = item.timestamp?.toDate().toLocaleString() || "(no time)";
        li.textContent = `${when} — ${item.progress}`;
        ul.appendChild(li);
      });
    }

    document.getElementById("addMemberForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const fullName = document.getElementById("newFullName").value.trim();
      const email = document.getElementById("newEmail").value.trim();
      const phone = document.getElementById("newPhone").value.trim();
      const gender = document.getElementById("newGender").value;
      const location = document.getElementById("newLocation").value.trim();
      const upline = document.getElementById("newUpline").value.trim();
      const memberId = document.getElementById("newMemberId").value.trim();
      const password = document.getElementById("newPassword").value;
      const msg = document.getElementById("addMemberMessage");
      msg.textContent = "";

      try {
        // Create user with secondary auth (won't switch admin session)
        const cred = await createUserWithEmailAndPassword(secondaryAuth, email, password);
        const uid = cred.user.uid;

        // Create member doc with manual memberId & empty photo
        await setDoc(doc(db, "members", uid), {
          memberId,
          fullName,
          email,
          phone,
          gender,
          location,
          upline,
          businessProgress: "",
          profilePhoto: "", // base64 slot for member upload later
          createdAt: serverTimestamp()
        });

        msg.textContent = "✅ Member registered successfully!";
        e.target.reset();

        // Sign out secondary session to keep it clean
        // (doesn't affect main admin session)
        await secondaryAuth.signOut();

        loadMembers();
      } catch (err) {
        msg.textContent = "❌ " + err.message;
      }
    });

    document.getElementById("exportCSV").addEventListener("click", async () => {
      const snap = await getDocs(collection(db, "members"));
      let csv = "Member ID,Full Name,Email,Phone,Gender,Location,Upline ID,Business Progress\n";
      snap.forEach((d) => {
        const m = d.data();
        csv += `"${m.memberId || ""}","${m.fullName || ""}","${m.email || ""}","${m.phone || ""}","${m.gender || ""}","${m.location || ""}","${m.upline || ""}","${m.businessProgress || ""}"\n`;
      });
      const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "LITA_Members.csv";
      document.body.appendChild(a);
      a.click();
      URL.revokeObjectURL(url);
    });

    document.getElementById("logout").addEventListener("click", () => signOut(auth).then(() => (window.location.href = "signin.html")));
  </script>
</body>
</html>
