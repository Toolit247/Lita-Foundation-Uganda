<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin Dashboard - LITA Foundation Uganda</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Firebase v8 -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>

  <!-- EmailJS -->
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>

  <!-- jsPDF + autoTable -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>

  <style>
    :root{--bg:#f6f7fb;--card:#fff;--text:#1f2937;--muted:#6b7280;--brand:#2563eb;--brand2:#1d4ed8;--border:#e5e7eb;--ok:#16a34a;--err:#dc2626}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);font-family:Inter,system-ui,Arial,sans-serif;color:var(--text)}
    header{display:flex;justify-content:space-between;align-items:center;padding:14px 18px;background:var(--card);border-bottom:1px solid var(--border)}
    .container{max-width:1150px;margin:18px auto;padding:0 14px}
    h2,h3{margin:0 0 10px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px;box-shadow:0 4px 16px rgba(0,0,0,.03)}
    .grid{display:grid;gap:14px}
    @media(min-width:900px){.grid-2{grid-template-columns:1.2fr .8fr}}
    input,select,button{padding:11px;border:1px solid var(--border);border-radius:10px;font:inherit}
    input,select{width:100%}
    .btn{background:var(--brand);color:#fff;border:none;cursor:pointer;font-weight:600}
    .btn:hover{background:var(--brand2)}
    .btn.secondary{background:#eef2ff;color:#111}
    .btn.danger{background:var(--err);color:#fff;border:none}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .toolbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .search{flex:1;min-width:220px}
    .msg{margin-top:8px;font-weight:600}
    .ok{color:var(--ok)} .err{color:var(--err)}
    .table-wrap{overflow:auto;border:1px solid var(--border);border-radius:12px;background:#fff}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid var(--border);font-size:14px;text-align:left;vertical-align:middle}
    th{background:#fafafa}
    .pill{background:#eef2ff;color:#1d4ed8;padding:2px 8px;border-radius:999px;font-size:12px}
    .avatar{width:36px;height:36px;border-radius:50%;object-fit:cover;border:1px solid var(--border)}
    ul.tree, ul.tree ul{list-style:none;margin-left:0;padding-left:18px}
    ul.tree li{margin:6px 0}
    .node{display:inline-flex;gap:8px;align-items:center;background:#fff;border:1px solid var(--border);border-radius:10px;padding:6px 10px;box-shadow:0 2px 10px rgba(0,0,0,.03)}
    .node img{width:28px;height:28px;border-radius:50%;object-fit:cover;border:1px solid var(--border)}
    .toggle{cursor:pointer;font-weight:700;color:#1d4ed8;margin-right:6px}
  </style>
</head>
<body>
<header>
  <div><strong>LITA • Admin Dashboard</strong></div>
  <div class="row">
    <input id="searchInput" placeholder="Search by name, email, phone, location, Member ID, Upline…" />
    <button id="exportCSV" class="btn secondary">Export CSV</button>
    <button id="exportPDF" class="btn secondary">Export PDF</button>
    <button id="logout" class="btn">Logout</button>
  </div>
</header>

<div class="container grid grid-2">
  <!-- Register Member -->
  <section class="card">
    <h3>Register New Member</h3>
    <form id="addMemberForm" class="grid">
      <div class="row">
        <input type="text" id="newFullName" placeholder="Full Name" required />
        <input type="email" id="newEmail" placeholder="Email" required />
      </div>
      <div class="row">
        <input type="text" id="newPhone" placeholder="Phone" required />
        <select id="newGender" required>
          <option value="">--Select Gender--</option>
          <option>Male</option><option>Female</option>
        </select>
      </div>
      <div class="row">
        <input type="text" id="newLocation" placeholder="Location" required />
        <input type="text" id="newUpline" placeholder="Upline Member ID (ROOT if none)" />
      </div>
      <div class="row">
        <input type="text" id="newMemberId" placeholder="Member ID (manual)" required />
        <input type="password" id="newPassword" placeholder="Temporary Password" required />
      </div>
      <div class="row" style="justify-content:flex-end">
        <button type="submit" class="btn">Register Member</button>
      </div>
      <div id="addMemberMessage" class="msg"></div>
    </form>
  </section>

  <!-- Member Tree -->
  <section class="card">
    <h3>Member Tree</h3>
    <ul id="treeRoot" class="tree"></ul>
  </section>

  <!-- Members table -->
  <section class="card" style="grid-column:1/-1">
    <h3>Registered Members</h3>
    <div class="table-wrap">
      <table id="membersTable">
        <thead>
          <tr>
            <th>Photo</th>
            <th>Full Name</th>
            <th>Email</th>
            <th>Member ID</th>
            <th>Phone</th>
            <th>Gender</th>
            <th>Location</th>
            <th>Upline</th>
            <th>Progress</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>
</div>

<script>
  var firebaseConfig = {
    apiKey: "AIzaSyAMnu2djtDKXMrTVKnppeCfKXRCy1KkEYk",
    authDomain: "lita-platform-bffdc.firebaseapp.com",
    projectId: "lita-platform-bffdc",
    storageBucket: "lita-platform-bffdc.appspot.com",
    messagingSenderId: "387943226211",
    appId: "1:387943226211:web:0127c409e0f880df391156"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // Secondary app for creating new users
  const secondary = firebase.apps.length < 2
    ? firebase.initializeApp(firebaseConfig, "secondary")
    : firebase.app("secondary");

  emailjs.init('hZgalRaZwSRy1Zgp4');

  // Auth guard
  firebase.auth().onAuthStateChanged(user => {
    if(!user || user.email!=="toolitambrosehenry@gmail.com") window.location.href="signin.html";
    else { loadMembers(); buildAndRenderTree(); }
  });

  // Load members + search
  let unsubMembers = null;
  function loadMembers(){
    if(unsubMembers) unsubMembers();
    unsubMembers = db.collection("members").orderBy("createdAt","desc").onSnapshot(snap=>{
      renderTable(snap.docs);
    });
  }

  function renderTable(docs){
    const q = (document.getElementById('searchInput').value||'').toLowerCase();
    const tbody = document.querySelector("#membersTable tbody");
    tbody.innerHTML = "";
    docs.forEach(doc=>{
      const d = doc.data();
      const hay = [d.fullName,d.email,d.phone,d.gender,d.location,d.upline,d.memberId].map(x=>(x||'').toLowerCase()).join(' ');
      if(q && !hay.includes(q)) return;
      const img = d.photoURL || ("https://ui-avatars.com/api/?background=E5E7EB&color=111&name="+encodeURIComponent(d.fullName||'LITA'));
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><img class="avatar" src="${img}" alt=""></td>
        <td>${d.fullName||''}</td>
        <td>${d.email||''}</td>
        <td><span class="pill">${d.memberId||'—'}</span></td>
        <td>${d.phone||''}</td>
        <td>${d.gender||''}</td>
        <td>${d.location||''}</td>
        <td>${d.upline||''}</td>
        <td>${d.businessProgress||'N/A'}</td>
        <td>
          <button class="btn secondary" data-edit="${doc.id}">Edit</button>
          <button class="btn danger" data-del="${doc.id}">Delete</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  document.getElementById("searchInput").addEventListener("input",()=>loadMembers());

  // Table actions: edit/delete
  document.getElementById("membersTable").addEventListener("click", async (e)=>{
    const eid = e.target.getAttribute("data-edit");
    const did = e.target.getAttribute("data-del");
    if(eid){
      const newId = prompt("Enter new Member ID:");
      if(newId) await db.collection("members").doc(eid).update({memberId:newId});
    }
    if(did && confirm("Delete this member (Firestore only)?")) {
      try { await db.collection("members").doc(did).delete(); buildAndRenderTree(); }
      catch(e){ alert(e.message); }
    }
  });

  // Register member
  document.getElementById("addMemberForm").addEventListener("submit", async e=>{
    e.preventDefault();
    const msg = document.getElementById("addMemberMessage"); msg.textContent="";
    const newMember = {
      fullName: document.getElementById("newFullName").value.trim(),
      email: document.getElementById("newEmail").value.trim(),
      phone: document.getElementById("newPhone").value.trim(),
      gender: document.getElementById("newGender").value,
      location: document.getElementById("newLocation").value.trim(),
      upline: document.getElementById("newUpline").value.trim()||'ROOT',
      memberId: document.getElementById("newMemberId").value.trim(),
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      businessProgress:'',
      photoURL:''
    };
    const tempPassword = document.getElementById("newPassword").value;
    try{
      await secondary.auth().createUserWithEmailAndPassword(newMember.email,tempPassword);
      const uid = secondary.auth().currentUser.uid;
      await db.collection("members").doc(uid).set(newMember);
      await secondary.auth().currentUser.delete(); // remove secondary app user
      msg.textContent="✅ Member registered successfully.";
      msg.className="msg ok";

      // EmailJS send
      emailjs.send('YOUR_SERVICE','YOUR_TEMPLATE',{to_email:newMember.email,to_name:newMember.fullName,temp_password:tempPassword})
      .catch(console.warn);

      document.getElementById("addMemberForm").reset();
      loadMembers();
      buildAndRenderTree();
    }catch(e){ msg.textContent="❌ "+e.message; msg.className="msg err"; }
  });

  document.getElementById("logout").addEventListener("click",()=>firebase.auth().signOut().then(()=>window.location.href="signin.html"));

  // -------- Recursive Downline tree --------
  async function fetchChildren(uplineId){
    const snap = await db.collection("members").where("upline","==",uplineId).get();
    const res=[];
    for(const doc of snap.docs){
      const d = doc.data();
      res.push({
        id:doc.id,
        fullName:d.fullName||"",
        memberId:d.memberId||"",
        photoURL:d.photoURL||"",
        children:await fetchChildren(d.memberId||"")
      });
    }
    return res;
  }

  function renderTreeNode(node,ul){
    const li=document.createElement("li");
    const hasChildren=node.children && node.children.length>0;
    const wrapper=document.createElement("div");
    wrapper.className="node";
    if(hasChildren){
      const toggle=document.createElement("span");
      toggle.textContent="▶"; toggle.className="toggle";
      wrapper.appendChild(toggle);
      toggle.addEventListener("click",()=>{ const s=sub.style.display==="none"; sub.style.display=s?"block":"none"; toggle.textContent=s?"▼":"▶"; });
    } else wrapper.appendChild(document.createElement("span"));
    const img=document.createElement("img"); img.src=node.photoURL||("https://ui-avatars.com/api/?background=E5E7EB&color=111&name="+encodeURIComponent(node.fullName||"LITA")); wrapper.appendChild(img);
    const label=document.createElement("div"); label.innerHTML=`<strong>${node.fullName}</strong> <span class="pill">${node.memberId}</span>`; wrapper.appendChild(label);
    li.appendChild(wrapper);
    if(hasChildren){
      const sub=document.createElement("ul"); sub.className="tree"; sub.style.display="none";
      node.children.forEach(ch=>renderTreeNode(ch,sub));
      li.appendChild(sub);
    }
    ul.appendChild(li);
  }

  async function buildAndRenderTree(){
    const target=document.getElementById("treeRoot"); target.innerHTML="";
    const rootNode={fullName:"ROOT",memberId:"ROOT",photoURL:"",children:await fetchChildren("ROOT")};
    const ul=document.createElement("ul"); renderTreeNode(rootNode,ul); target.appendChild(ul);
  }

  // Export CSV
  document.getElementById("exportCSV").addEventListener("click", async ()=>{
    const snap = await db.collection("members").get();
    const rows = snap.docs.map(d=>d.data());
    const csv = ["Full Name,Email,Member ID,Phone,Gender,Location,Upline,Progress"].concat(
      rows.map(r=>`"${r.fullName}","${r.email}","${r.memberId}","${r.phone}","${r.gender}","${r.location}","${r.upline}","${r.businessProgress}"`)
    ).join("\n");
    const blob = new Blob([csv],{type:"text/csv"});
    const url=URL.createObjectURL(blob); const a=document.createElement("a"); a.href=url; a.download="members.csv"; a.click();
    URL.revokeObjectURL(url);
  });

  // Export PDF
  document.getElementById("exportPDF").addEventListener("click", async ()=>{
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const snap = await db.collection("members").get();
    const rows = snap.docs.map(d=>d.data());
    const body = rows.map(r=>[r.fullName,r.email,r.memberId,r.phone,r.gender,r.location,r.upline,r.businessProgress]);
    doc.autoTable({head:[["Name","Email","ID","Phone","Gender","Location","Upline","Progress"]],body});
    doc.save("members.pdf");
  });
</script>
</body>
</html>
