<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin Dashboard - LITA Foundation Uganda</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Firebase v8 -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>

  <!-- EmailJS -->
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>

  <!-- jsPDF + autoTable -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>

  <style>
    :root{--bg:#f6f7fb;--card:#fff;--text:#1f2937;--muted:#6b7280;--brand:#2563eb;--brand2:#1d4ed8;--border:#e5e7eb;--ok:#16a34a;--err:#dc2626}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);font-family:Inter,system-ui,Arial,sans-serif;color:var(--text)}
    header{display:flex;justify-content:space-between;align-items:center;padding:14px 18px;background:var(--card);border-bottom:1px solid var(--border);position:sticky;top:0;z-index:10}
    .container{max-width:1150px;margin:18px auto;padding:0 14px}
    h2,h3{margin:0 0 10px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px;box-shadow:0 4px 16px rgba(0,0,0,.03)}
    .grid{display:grid;gap:14px}
    @media(min-width:900px){.grid-2{grid-template-columns:1.2fr .8fr}}
    input,select,button{padding:11px;border:1px solid var(--border);border-radius:10px;font:inherit}
    input,select{width:100%}
    .btn{background:var(--brand);color:#fff;border:none;cursor:pointer;font-weight:600}
    .btn:hover{background:var(--brand2)}
    .btn.secondary{background:#eef2ff;color:#111}
    .btn.danger{background:var(--err);color:#fff;border:none}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .toolbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .search{flex:1;min-width:220px}
    .msg{margin-top:8px;font-weight:600}
    .ok{color:var(--ok)} .err{color:var(--err)}
    .table-wrap{overflow:auto;border:1px solid var(--border);border-radius:12px;background:#fff}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid var(--border);font-size:14px;text-align:left;vertical-align:middle}
    th{background:#fafafa}
    .pill{background:#eef2ff;color:#1d4ed8;padding:2px 8px;border-radius:999px;font-size:12px}
    .avatar{width:36px;height:36px;border-radius:50%;object-fit:cover;border:1px solid var(--border)}
    ul.tree, ul.tree ul{list-style:none;margin-left:0;padding-left:18px}
    ul.tree li{margin:6px 0}
    .node{display:inline-flex;gap:8px;align-items:center;background:#fff;border:1px solid var(--border);border-radius:10px;padding:6px 10px;box-shadow:0 2px 10px rgba(0,0,0,.03)}
    .node img{width:28px;height:28px;border-radius:50%;object-fit:cover;border:1px solid var(--border)}
  </style>
</head>
<body>
<header>
  <div><strong>LITA • Admin Dashboard</strong></div>
  <div class="row">
    <input id="searchInput" placeholder="Search by name, email, phone, location, Member ID, Upline…" />
    <button id="exportCSV" class="btn secondary">Export CSV</button>
    <button id="exportPDF" class="btn secondary">Export PDF</button>
    <button id="logout" class="btn">Logout</button>
  </div>
</header>

<div class="container grid grid-2">
  <!-- Register Member -->
  <section class="card">
    <h3>Register New Member</h3>
    <p style="color:#6b7280;font-size:13px;margin-bottom:8px">Creates an Auth account with a temporary password and sends details via EmailJS.</p>
    <form id="addMemberForm" class="grid">
      <div class="row">
        <input type="text" id="newFullName" placeholder="Full Name" required />
        <input type="email" id="newEmail" placeholder="Email" required />
      </div>
      <div class="row">
        <input type="text" id="newPhone" placeholder="Phone" required />
        <select id="newGender" required>
          <option value="">--Select Gender--</option>
          <option>Male</option><option>Female</option>
        </select>
      </div>
      <div class="row">
        <input type="text" id="newLocation" placeholder="Location" required />
        <input type="text" id="newUpline" placeholder="Upline Member ID (ROOT if none)" />
      </div>
      <div class="row">
        <input type="text" id="newMemberId" placeholder="Member ID (manual)" required />
        <input type="password" id="newPassword" placeholder="Temporary Password" required />
      </div>
      <div class="row" style="justify-content:flex-end">
        <button type="submit" class="btn">Register Member</button>
      </div>
      <div id="addMemberMessage" class="msg"></div>
    </form>
  </section>

  <!-- Member Tree -->
  <section class="card">
    <h3>Member Tree</h3>
    <ul id="treeRoot" class="tree"></ul>
  </section>

  <!-- Members table -->
  <section class="card" style="grid-column:1/-1">
    <h3>Registered Members</h3>
    <div class="table-wrap">
      <table id="membersTable">
        <thead>
          <tr>
            <th>Photo</th><th>Full Name</th><th>Email</th><th>Member ID</th>
            <th>Phone</th><th>Gender</th><th>Location</th><th>Upline</th>
            <th>Progress</th><th>History</th><th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>
</div>

<script>
  // Firebase config
  var firebaseConfig = {
    apiKey: "AIzaSyAMnu2djtDKXMrTVKnppeCfKXRCy1KkEYk",
    authDomain: "lita-platform-bffdc.firebaseapp.com",
    projectId: "lita-platform-bffdc",
    storageBucket: "lita-platform-bffdc.appspot.com",
    messagingSenderId: "387943226211",
    appId: "1:387943226211:web:0127c409e0f880df391156"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const secondary = firebase.initializeApp(firebaseConfig, "secondary");

  // EmailJS
  emailjs.init("hZgalRaZwSRy1Zgp4");

  // Route guard
  firebase.auth().onAuthStateChanged(user => {
    if (!user || user.email !== "toolitambrosehenry@gmail.com") {
      window.location.href = "signin.html";
    } else {
      loadMembers();
      buildAndRenderTree();
    }
  });

  // Register member
  document.getElementById("addMemberForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const msg = document.getElementById("addMemberMessage");
    msg.textContent = ""; msg.className = "msg";

    const fullName = document.getElementById("newFullName").value.trim();
    const email = document.getElementById("newEmail").value.trim();
    const phone = document.getElementById("newPhone").value.trim();
    const gender = document.getElementById("newGender").value;
    const location = document.getElementById("newLocation").value.trim();
    const upline = document.getElementById("newUpline").value.trim() || "ROOT";
    const memberId = document.getElementById("newMemberId").value.trim();
    const password = document.getElementById("newPassword").value;

    try {
      // Create Auth user
      const cred = await secondary.auth().createUserWithEmailAndPassword(email, password);
      const uid = cred.user.uid;

      // Firestore profile
      await db.collection("members").doc(uid).set({
        fullName, email, phone, gender, location, upline, memberId,
        businessProgress: "",
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });

      // EmailJS send (with temp password)
      await emailjs.send("service_mrqs34o", "template_svacje4", {
        to_email: email,
        full_name: fullName,
        member_id: memberId,
        upline_id: upline,
        phone: phone,
        location: location,
        temp_password: password
      });

      await secondary.auth().signOut();
      e.target.reset();
      msg.textContent = "✅ Member registered and email sent.";
      msg.classList.add("ok");
      buildAndRenderTree();
    } catch(err){
      msg.textContent = "❌ " + err.message;
      msg.classList.add("err");
    }
  });

  // (other code: loadMembers, renderTable, exports, tree builder — unchanged)
</script>
</body>
</html>
