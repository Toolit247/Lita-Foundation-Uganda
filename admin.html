<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>LITA Admin Dashboard</title>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    ul { list-style-type: none; padding-left: 20px; }
    li { margin: 10px 0; }
  </style>
</head>
<body class="bg-gray-100 p-6">
  <h1 class="text-2xl font-bold mb-4">Admin Dashboard - LITA Foundation Uganda</h1>

  <!-- Member Registration Form -->
  <div class="bg-white p-4 rounded shadow mb-6">
    <h2 class="text-xl font-semibold mb-2">Register New Member</h2>
    <form id="registerForm" class="space-y-2">
      <input type="text" id="idNumber" placeholder="ID Number" class="w-full border p-2 rounded" required>
      <input type="text" id="name" placeholder="Full Name" class="w-full border p-2 rounded" required>
      <input type="email" id="email" placeholder="Email" class="w-full border p-2 rounded" required>
      <input type="text" id="uplineId" placeholder="Upline ID (ROOT if none)" class="w-full border p-2 rounded">
      <input type="file" id="photo" class="w-full border p-2 rounded" accept="image/*">
      <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded">Register</button>
    </form>
  </div>

  <!-- Tree Diagram -->
  <div class="bg-white p-4 rounded shadow">
    <h2 class="text-xl font-semibold mb-2">Member Tree</h2>
    <ul id="treeView"></ul>
  </div>

  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyAMnu2djtDKXMrTVKnppeCfKXRCy1KkEYk",
      authDomain: "lita-platform-bffdc.firebaseapp.com",
      projectId: "lita-platform-bffdc",
      storageBucket: "lita-platform-bffdc.appspot.com",
      messagingSenderId: "387943226211",
      appId: "1:387943226211:web:0127c409e0f880df391156"
    };

    const app = firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const storage = firebase.storage();

    // Register Member
    document.getElementById("registerForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const idNumber = document.getElementById("idNumber").value;
      const name = document.getElementById("name").value;
      const email = document.getElementById("email").value;
      const uplineId = document.getElementById("uplineId").value || "ROOT";
      const file = document.getElementById("photo").files[0];

      let photoUrl = "";
      if (file) {
        const storageRef = storage.ref("photos/" + idNumber);
        await storageRef.put(file);
        photoUrl = await storageRef.getDownloadURL();
      }

      await db.collection("members").doc(idNumber).set({
        idNumber, name, email, uplineId, photoUrl, progress: []
      });

      alert("Member Registered Successfully!");
      showFullTree();
    });

    // Recursive build tree
    async function buildTree(memberId) {
      const snapshot = await db.collection("members").where("uplineId", "==", memberId).get();
      let children = [];
      for (const doc of snapshot.docs) {
        const data = doc.data();
        children.push({
          idNumber: data.idNumber,
          name: data.name,
          photoUrl: data.photoUrl || "",
          children: await buildTree(data.idNumber)
        });
      }
      return children;
    }

    function renderTree(node, container) {
      let li = document.createElement("li");
      li.innerHTML = `
        <div class="p-2 shadow rounded bg-white inline-flex items-center">
          <img src="${node.photoUrl}" class="w-12 h-12 rounded-full mr-2"/>
          <span class="font-bold">${node.name}</span> <small>(${node.idNumber})</small>
        </div>
      `;
      if (node.children && node.children.length > 0) {
        let ul = document.createElement("ul");
        node.children.forEach(child => renderTree(child, ul));
        li.appendChild(ul);
      }
      container.appendChild(li);
    }

    async function showFullTree() {
      const rootNode = {
        idNumber: "ROOT",
        name: "LITA Network",
        photoUrl: "",
        children: await buildTree("ROOT")
      };
      let container = document.getElementById("treeView");
      container.innerHTML = "";
      renderTree(rootNode, container);
    }

    showFullTree();
  </script>
</body>
</html>
