<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>LITA Member Dashboard</title>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    ul { list-style-type: none; padding-left: 20px; }
    li { margin: 10px 0; }
  </style>
</head>
<head>
  <meta charset="UTF-8">
  <title>Member Dashboard - LITA Foundation</title>
  <!-- Firebase v8 -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#f6f7fb;--card:#fff;--text:#111827;--muted:#6b7280;--brand:#2563eb;--border:#e5e7eb;--success:#16a34a;--danger:#dc2626;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);font-family:Inter,system-ui,Arial,sans-serif;color:var(--text)}
    header{display:flex;justify-content:space-between;align-items:center;padding:16px 20px;background:var(--card);box-shadow:0 2px 8px rgba(0,0,0,.04);position:sticky;top:0;z-index:10}
    .title{font-weight:700}
    .btn{background:var(--brand);color:#fff;border:none;border-radius:10px;padding:10px 14px;cursor:pointer;font-weight:600;transition:.2s}
    .btn:hover{filter:brightness(.95)}
    .container{max-width:980px;margin:22px auto;padding:0 16px;display:grid;gap:16px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;box-shadow:0 4px 16px rgba(0,0,0,.04);padding:18px}
    .profile{display:flex;gap:16px;align-items:center}
    .avatar{width:84px;height:84px;border-radius:999px;object-fit:cover;border:2px solid var(--border);cursor:pointer}
    .muted{color:var(--muted);font-size:13px}
    .grid{display:grid;gap:12px}
    @media(min-width:900px){.grid-2{grid-template-columns:1fr 1fr}}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid var(--border);text-align:left;font-size:14px}
    th{background:#fafafa}
    input,textarea{width:100%;padding:12px;border:1px solid var(--border);border-radius:10px;outline:none}
    input:focus,textarea:focus{border-color:var(--brand)}
    .msg{margin-top:8px;font-weight:600}
    .ok{color:var(--success)}
    .err{color:var(--danger)}
    .pill{background:#eef2ff;color:#1d4ed8;padding:2px 8px;border-radius:999px;font-size:12px}
  </style>
</head>
<body>
  <header>
    <div class="title">LITA • Member Dashboard</div>
    <button id="logout" class="btn">Logout</button>
  </header>

  <div class="container">
    <!-- Profile Card -->
    <section class="card">
      <div class="profile">
        <img id="avatar" class="avatar" src="https://ui-avatars.com/api/?background=E5E7EB&color=111&name=LITA" alt="Profile Photo" title="Click to change photo" />
        <input id="photoInput" type="file" accept="image/*" style="display:none" />
        <div>
          <div id="name" style="font-size:18px;font-weight:700">—</div>
          <div class="muted" id="email">—</div>
          <div class="muted">Member ID: <span id="memberId" class="pill">—</span></div>
          <div class="muted tiny" id="photoMsg"></div>
        </div>
      </div>
    </section>
 <!-- Details + Progress -->
    <section class="grid grid-2">
      <div class="card">
        <h3>Your Details</h3>
        <table>
          <tbody id="detailsBody"></tbody>
        </table>
      </div>

      <div class="card">
        <h3>Update Business Progress</h3>
        <form id="progressForm">
          <textarea id="businessProgress" placeholder="Describe your current business progress…" required></textarea>
          <div style="display:flex;justify-content:flex-end;margin-top:8px">
            <button class="btn" type="submit">Update Progress</button>
          </div>
          <div id="updateMessage" class="msg"></div>
        </form>
      </div>
    </section>

    <!-- History -->
    <section class="card">
      <h3>Progress History</h3>
      <ul id="progressHistory" style="padding-left:18px;margin:0"></ul>
    </section>
  </div>
<body class="bg-gray-100 p-6">
  <h1 class="text-2xl font-bold mb-4">Member Dashboard - LITA Foundation Uganda</h1>

  <!-- Profile -->
  <div id="profile" class="bg-white p-4 rounded shadow mb-6"></div>

  <!-- Progress History -->
  <div class="bg-white p-4 rounded shadow mb-6">
    <h2 class="text-xl font-semibold mb-2">Progress History</h2>
    <ul id="progressList"></ul>
  </div>

  <!-- My Tree -->
  <div class="bg-white p-4 rounded shadow">
    <h2 class="text-xl font-semibold mb-2">My Downline Tree</h2>
    <ul id="myTreeView"></ul>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAMnu2djtDKXMrTVKnppeCfKXRCy1KkEYk",
      authDomain: "lita-platform-bffdc.firebaseapp.com",
      projectId: "lita-platform-bffdc",
      storageBucket: "lita-platform-bffdc.appspot.com",
      messagingSenderId: "387943226211",
      appId: "1:387943226211:web:0127c409e0f880df391156"
    };
firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const storage = firebase.storage();

    let memberDocRef = null;
    let userUid = null;

    firebase.auth().onAuthStateChanged(user => {
      if (!user) {
        window.location.href = "signin.html";
      } else {
        userUid = user.uid;
        setupLiveMemberDoc(user.uid);
      }
    });

    // Live document listener so changes (e.g., Member ID by admin) appear instantly
    function setupLiveMemberDoc(uid) {
      memberDocRef = db.collection("members").doc(uid);
      memberDocRef.onSnapshot(doc => {
        if (!doc.exists) return;
        const d = doc.data();

        // Profile header
        document.getElementById("name").textContent = d.fullName || "—";
        document.getElementById("email").textContent = d.email || "—";
        document.getElementById("memberId").textContent = d.memberId || "—";
        const avatar = document.getElementById("avatar");
        avatar.src = d.photoURL || ("https://ui-avatars.com/api/?background=E5E7EB&color=111&name=" + encodeURIComponent(d.fullName||"LITA"));

        // Details table
        const body = document.getElementById("detailsBody");
        body.innerHTML = `
          <tr><td>Full Name</td><td>${d.fullName || ""}</td></tr>
          <tr><td>Email</td><td>${d.email || ""}</td></tr>
          <tr><td>Phone</td><td>${d.phone || ""}</td></tr>
          <tr><td>Gender</td><td>${d.gender || ""}</td></tr>
          <tr><td>Location</td><td>${d.location || ""}</td></tr>
          <tr><td>Upline ID</td><td>${d.upline || ""}</td></tr>
          <tr><td>Current Progress</td><td>${d.businessProgress || "N/A"}</td></tr>
        `;

        loadProgressHistory(); // refresh history after any change
      });
    }

    // Load progress history (latest first)
    function loadProgressHistory() {
      if (!memberDocRef) return;
      memberDocRef.collection("progressHistory").orderBy("timestamp","desc").get().then(snapshot => {
        const ul = document.getElementById("progressHistory");
        ul.innerHTML = "";
        snapshot.forEach(doc => {
          const d = doc.data();
          const li = document.createElement("li");
          const time = d.timestamp && d.timestamp.toDate ? d.timestamp.toDate().toLocaleString() : "—";
          li.textContent = `${time} — ${d.progress}`;
          ul.appendChild(li);
        });
      });
    }

    // Update progress
    document.getElementById("progressForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const msg = document.getElementById("updateMessage");
      msg.textContent = ""; msg.className = "msg";
      const progress = document.getElementById("businessProgress").value.trim();
      if (!progress) return;

      try {
        await memberDocRef.update({ businessProgress: progress });
        await memberDocRef.collection("progressHistory").add({
          progress,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
        document.getElementById("businessProgress").value = "";
        msg.textContent = "✅ Progress updated successfully!";
        msg.classList.add("ok");
        loadProgressHistory();
      } catch (err) {
        msg.textContent = "❌ " + err.message;
        msg.classList.add("err");
      }
    });

    // Photo upload (member-controlled)
    const avatarEl = document.getElementById("avatar");
    const fileEl = document.getElementById("photoInput");
    const photoMsg = document.getElementById("photoMsg");

    avatarEl.addEventListener("click", ()=> fileEl.click());
    fileEl.addEventListener("change", async (e) => {
      const file = e.target.files[0];
      if (!file || !userUid) return;
      photoMsg.textContent = "Uploading photo…";
      try {
        const ref = storage.ref().child(`profiles/${userUid}.jpg`);
        await ref.put(file);
        const url = await ref.getDownloadURL();
        await memberDocRef.update({ photoURL: url });
        avatarEl.src = url;
        photoMsg.textContent = "✅ Photo updated!";
        setTimeout(()=> photoMsg.textContent = "", 2000);
      } catch (err) {
        photoMsg.textContent = "❌ " + err.message;
      }
    });

    // Logout
    document.getElementById("logout").addEventListener("click", () => {
      firebase.auth().signOut().then(()=> location.href="signin.html");
    });
    const app = firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let currentId = null;

    auth.onAuthStateChanged(async (user) => {
      if (user) {
        const snapshot = await db.collection("members").where("email", "==", user.email).get();
        if (!snapshot.empty) {
          const data = snapshot.docs[0].data();
          currentId = data.idNumber;
          document.getElementById("profile").innerHTML = `
            <div class="flex items-center">
              <img src="${data.photoUrl}" class="w-16 h-16 rounded-full mr-4"/>
              <div>
                <p class="font-bold">${data.name}</p>
                <p>ID: ${data.idNumber}</p>
                <p>Email: ${data.email}</p>
              </div>
            </div>
          `;
          let progressHTML = "";
          (data.progress || []).forEach(p => {
            progressHTML += `<li class="border-b py-1">${p.date}: ${p.note}</li>`;
          });
          document.getElementById("progressList").innerHTML = progressHTML;

          showMyTree(currentId, data);
        }
      }
    });

    async function buildTree(memberId) {
      const snapshot = await db.collection("members").where("uplineId", "==", memberId).get();
      let children = [];
      for (const doc of snapshot.docs) {
        const data = doc.data();
        children.push({
          idNumber: data.idNumber,
          name: data.name,
          photoUrl: data.photoUrl || "",
          children: await buildTree(data.idNumber)
        });
      }
      return children;
    }

    function renderTree(node, container) {
      let li = document.createElement("li");
      li.innerHTML = `
        <div class="p-2 shadow rounded bg-white inline-flex items-center">
          <img src="${node.photoUrl}" class="w-12 h-12 rounded-full mr-2"/>
          <span class="font-bold">${node.name}</span> <small>(${node.idNumber})</small>
        </div>
      `;
      if (node.children && node.children.length > 0) {
        let ul = document.createElement("ul");
        node.children.forEach(child => renderTree(child, ul));
        li.appendChild(ul);
      }
      container.appendChild(li);
    }

    async function showMyTree(myId, data) {
      const rootNode = {
        idNumber: data.idNumber,
        name: data.name,
        photoUrl: data.photoUrl || "",
        children: await buildTree(data.idNumber)
      };
      let container = document.getElementById("myTreeView");
      container.innerHTML = "";
      renderTree(rootNode, container);
    }
passward change option

<h3>Change Password</h3>
<form id="changePasswordForm">
  <input type="password" id="currentPassword" placeholder="Current Password" required />
  <input type="password" id="newPassword" placeholder="New Password" required />
  <input type="password" id="confirmNewPassword" placeholder="Confirm New Password" required />
  <button type="submit">Change Password</button>
  <div class="message" id="passwordChangeMessage"></div>
</form>
  </script>
</body>
</html>
















