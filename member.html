<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Member Dashboard - LITA Foundation Uganda</title>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
  <script>
    // Initialize EmailJS
    (function() {
      emailjs.init("hZgalRaZwSRy1Zgp4");
    })();
  </script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h1 { color: #2c3e50; }
    .progress-entry { border: 1px solid #ccc; padding: 10px; margin: 5px; border-radius: 6px; }
    button { margin: 2px; padding: 4px 8px; border-radius: 4px; cursor: pointer; }
    .tree ul { list-style-type: none; margin-left: 20px; padding-left: 15px; border-left: 1px dashed #ccc; }
    .tree li { margin: 6px 0; }
    .toggle { cursor: pointer; font-weight: bold; color: #007BFF; }
  </style>
</head>
<body>
  <h1>Member Dashboard</h1>
  <div id="memberInfo"></div>

  <h2>Progress History</h2>
  <div id="progressHistory"></div>

  <h2>Your Downline</h2>
  <div id="downlineTree" class="tree"></div>

  <button onclick="logout()">Logout</button>

  <script>
    // ðŸ”¥ Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyAMnu2djtDKXMrTVKnppeCfKXRCy1KkEYk",
      authDomain: "lita-platform-bffdc.firebaseapp.com",
      projectId: "lita-platform-bffdc",
      storageBucket: "lita-platform-bffdc.firebasestorage.app",
      messagingSenderId: "387943226211",
      appId: "1:387943226211:web:0127c409e0f880df391156",
      measurementId: "G-44JEYP8ZHD"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // âœ… Render Progress History with Edit/Delete
    function renderProgress(history) {
      const container = document.getElementById("progressHistory");
      container.innerHTML = "";
      history.forEach(item => {
        const div = document.createElement("div");
        div.className = "progress-entry";
        div.innerHTML = `
          <p><b>${item.date}</b>: ${item.update}</p>
          <button onclick="editProgress('${item.id}', '${item.update}')">Edit</button>
          <button onclick="deleteProgress('${item.id}')">Delete</button>
        `;
        container.appendChild(div);
      });
    }

    async function editProgress(id, oldUpdate) {
      const newUpdate = prompt("Edit your progress:", oldUpdate);
      if (newUpdate) {
        await db.collection("progress").doc(id).update({ update: newUpdate });
        loadMemberData(auth.currentUser.uid);
      }
    }

    async function deleteProgress(id) {
      if (confirm("Delete this progress?")) {
        await db.collection("progress").doc(id).delete();
        loadMemberData(auth.currentUser.uid);
      }
    }

    // âœ… Recursive Downline Renderer
    function renderTreeNode(member, container) {
      const li = document.createElement("li");
      const toggle = document.createElement("span");
      toggle.textContent = member.name + " (" + member.id + ")";
      toggle.className = "toggle";

      const childrenList = document.createElement("ul");
      childrenList.style.display = "none";

      toggle.onclick = () => {
        childrenList.style.display = childrenList.style.display === "none" ? "block" : "none";
      };

      li.appendChild(toggle);

      if (member.downlines && member.downlines.length > 0) {
        member.downlines.forEach(child => {
          renderTreeNode(child, childrenList);
        });
        li.appendChild(childrenList);
      }

      container.appendChild(li);
    }

    function renderDownlineTree(treeData) {
      const container = document.getElementById("downlineTree");
      container.innerHTML = "";
      const ul = document.createElement("ul");
      renderTreeNode(treeData, ul);
      container.appendChild(ul);
    }

    // âœ… Load member data (profile + progress + downline)
    async function loadMemberData(uid) {
      const memberDoc = await db.collection("members").doc(uid).get();
      const memberData = memberDoc.data();

      document.getElementById("memberInfo").innerHTML = `
        <p><b>Name:</b> ${memberData.name}</p>
        <p><b>Email:</b> ${memberData.email}</p>
        <p><b>Member ID:</b> ${memberData.memberId}</p>
      `;

      // Load progress
      const progressSnap = await db.collection("progress")
        .where("memberId", "==", memberData.memberId).get();
      const progress = progressSnap.docs.map(doc => ({
        id: doc.id,
        ...doc.data()
      }));
      renderProgress(progress);

      // Load downline tree (mock/demo structure)
      const downlineTree = {
        id: memberData.memberId,
        name: memberData.name,
        downlines: [
          { id: "M101", name: "Downline A", downlines: [
            { id: "M201", name: "Sub A1", downlines: [] }
          ]},
          { id: "M102", name: "Downline B", downlines: [] }
        ]
      };
      renderDownlineTree(downlineTree);
    }

    // âœ… Auth listener
    auth.onAuthStateChanged(user => {
      if (user) {
        loadMemberData(user.uid);
      } else {
        window.location.href = "index.html";
      }
    });

    function logout() {
      auth.signOut();
    }
  </script>
</body>
</html>
