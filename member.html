<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>LITA Member Dashboard</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f9f9f9;
      margin: 0; padding: 0;
    }
    header {
      background: #006400;
      color: #fff;
      padding: 15px;
      text-align: center;
    }
    .container { padding: 20px; }
    .card {
      background: #fff;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    h2 { margin-top: 0; color: #333; }
    table {
      width: 100%; border-collapse: collapse; margin-top: 10px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px; text-align: left;
    }
    th { background: #f1f1f1; }
    button {
      padding: 6px 12px;
      margin: 3px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .btn-primary { background: #006400; color: #fff; }
    .btn-danger { background: #b22222; color: #fff; }
    .btn-secondary { background: #555; color: #fff; }
    .tree ul {
      padding-left: 20px; list-style: none;
    }
    .tree li { margin: 5px 0; }
  </style>
</head>
<body>
<header>
  <h1>Member Dashboard</h1>
</header>
<div class="container">

  <!-- Profile Info -->
  <div class="card">
    <h2>My Profile</h2>
    <p><strong>Name:</strong> <span id="memberName"></span></p>
    <p><strong>Email:</strong> <span id="memberEmail"></span></p>
    <p><strong>Member ID:</strong> <span id="memberId"></span></p>
    <button class="btn-secondary" onclick="sendPasswordReset()">Reset Password</button>
    <button class="btn-danger" onclick="logout()">Logout</button>
  </div>

  <!-- Progress History -->
  <div class="card">
    <h2>My Business Progress</h2>
    <input type="text" id="progressSearch" placeholder="Search progress..." onkeyup="filterProgress()">
    <table id="progressTable">
      <thead>
        <tr><th>Date</th><th>Update</th><th>Actions</th></tr>
      </thead>
      <tbody id="progressBody"></tbody>
    </table>
    <button class="btn-primary" onclick="exportProgress('csv')">Export CSV</button>
    <button class="btn-primary" onclick="exportProgress('pdf')">Export PDF</button>
  </div>

  <!-- Downline Tree -->
  <div class="card">
    <h2>My Downline</h2>
    <div class="tree" id="downlineTree"></div>
  </div>

</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

<script>
  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyAMnu2djtDKXMrTVKnppeCfKXRCy1KkEYk",
    authDomain: "lita-platform-bffdc.firebaseapp.com",
    projectId: "lita-platform-bffdc",
    storageBucket: "lita-platform-bffdc.appspot.com",
    messagingSenderId: "387943226211",
    appId: "1:387943226211:web:0127c409e0f880df391156"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  // Auth state
  auth.onAuthStateChanged(user => {
    if (!user) {
      window.location.href = "login.html";
    } else {
      loadProfile(user);
      loadProgress(user.uid);
      loadDownline(user.uid);
    }
  });

  function logout(){ auth.signOut(); }

  function sendPasswordReset(){
    const user = auth.currentUser;
    if(user && user.email){
      auth.sendPasswordResetEmail(user.email)
        .then(() => alert("Password reset email sent."))
        .catch(err => alert("Error: " + err.message));
    }
  }

  function loadProfile(user){
    document.getElementById("memberName").innerText = user.displayName || "N/A";
    document.getElementById("memberEmail").innerText = user.email;
    db.collection("members").doc(user.uid).get().then(doc=>{
      if(doc.exists){
        document.getElementById("memberId").innerText = doc.data().memberId || "N/A";
      }
    });
  }

  function loadProgress(uid){
    db.collection("progress").where("uid","==",uid).onSnapshot(snapshot=>{
      let body = document.getElementById("progressBody");
      body.innerHTML="";
      snapshot.forEach(doc=>{
        let d=doc.data();
        let tr=document.createElement("tr");
        tr.innerHTML=`
          <td>${d.date||""}</td>
          <td>${d.update||""}</td>
          <td>
            <button class="btn-secondary" onclick="editProgress('${doc.id}','${d.update}')">Edit</button>
            <button class="btn-danger" onclick="deleteProgress('${doc.id}')">Delete</button>
          </td>`;
        body.appendChild(tr);
      });
    });
  }

  function editProgress(id, current){
    let updated=prompt("Edit progress:", current);
    if(updated){
      db.collection("progress").doc(id).update({update:updated});
    }
  }
  function deleteProgress(id){
    if(confirm("Delete this progress?")){
      db.collection("progress").doc(id).delete();
    }
  }

  function filterProgress(){
    let input=document.getElementById("progressSearch").value.toLowerCase();
    document.querySelectorAll("#progressBody tr").forEach(row=>{
      row.style.display=row.innerText.toLowerCase().includes(input)?"":"none";
    });
  }

  // Export
  function exportProgress(type){
    let rows=[["Date","Update"]];
    document.querySelectorAll("#progressBody tr").forEach(tr=>{
      let cols=tr.querySelectorAll("td");
      rows.push([cols[0].innerText, cols[1].innerText]);
    });
    if(type==="csv"){
      let csv=rows.map(r=>r.join(",")).join("\n");
      let blob=new Blob([csv],{type:"text/csv"});
      let a=document.createElement("a");
      a.href=URL.createObjectURL(blob);
      a.download="progress.csv";
      a.click();
    } else if(type==="pdf"){
      let win=window.open("");
      win.document.write("<pre>"+rows.map(r=>r.join("\t")).join("\n")+"</pre>");
      win.print();
    }
  }

  // Recursive Downline
  function loadDownline(uid){
    let treeDiv=document.getElementById("downlineTree");
    treeDiv.innerHTML="";
    function buildTree(id, parentEl){
      db.collection("members").where("sponsorId","==",id).get().then(snap=>{
        if(!snap.empty){
          let ul=document.createElement("ul");
          snap.forEach(doc=>{
            let li=document.createElement("li");
            li.innerText=doc.data().name || "Unnamed";
            ul.appendChild(li);
            buildTree(doc.id, li);
          });
          parentEl.appendChild(ul);
        }
      });
    }
    buildTree(uid, treeDiv);
  }
</script>
</body>
</html>
