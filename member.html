<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>LITA Foundation Uganda - Member Dashboard</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center">
  <div class="w-full max-w-5xl mt-8 p-6 bg-white shadow-md rounded-lg">
    <h1 class="text-2xl font-bold text-center text-indigo-600 mb-6">Member Dashboard</h1>

    <!-- Profile Section -->
    <div class="mb-6">
      <h2 class="text-lg font-semibold mb-2">Profile</h2>
      <div class="flex items-center space-x-4">
        <img id="profilePhoto" class="w-20 h-20 rounded-full border" src="https://via.placeholder.com/100" alt="Profile Photo">
        <div>
          <p><strong>Name:</strong> <span id="memberName">Loading...</span></p>
          <p><strong>Email:</strong> <span id="memberEmail">Loading...</span></p>
          <button id="resetPasswordBtn" class="mt-2 px-3 py-1 bg-yellow-500 text-white rounded">Reset Password</button>
        </div>
      </div>
    </div>

    <!-- Business Progress Section -->
    <div class="mb-6">
      <h2 class="text-lg font-semibold mb-2">Business Progress</h2>
      <form id="progressForm" class="flex space-x-2 mb-3">
        <input type="text" id="progressInput" placeholder="Enter progress update" class="flex-grow border rounded p-2">
        <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded">Add</button>
      </form>
      <ul id="progressList" class="list-disc ml-6"></ul>
    </div>

    <!-- Downline Tree Section -->
    <div class="mb-6">
      <h2 class="text-lg font-semibold mb-2">My Downline</h2>
      <div id="downlineTree" class="p-4 bg-gray-50 border rounded"></div>
    </div>

    <!-- Logout -->
    <div class="text-center">
      <button id="logoutBtn" class="px-4 py-2 bg-red-600 text-white rounded">Logout</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, collection, addDoc, onSnapshot, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyAMnu2djtDKXMrTVKnppeCfKXRCy1KkEYk",
      authDomain: "lita-platform-bffdc.firebaseapp.com",
      projectId: "lita-platform-bffdc",
      storageBucket: "lita-platform-bffdc.appspot.com",
      messagingSenderId: "387943226211",
      appId: "1:387943226211:web:0127c409e0f880df391156",
      measurementId: "G-44JEYP8ZHD"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let currentUserId = null;

    // Recursive tree builder
    async function buildTree(memberId, container) {
      const docRef = doc(db, "members", memberId);
      const snap = await getDoc(docRef);
      if (!snap.exists()) return;

      const data = snap.data();
      const node = document.createElement("div");
      node.classList.add("ml-4", "mt-2");
      node.innerHTML = `<strong>${data.name || "Unnamed"}</strong> (${data.memberId || ""})`;
      container.appendChild(node);

      if (data.downlines && Array.isArray(data.downlines)) {
        for (const childId of data.downlines) {
          await buildTree(childId, node);
        }
      }
    }

    // Listen for auth state
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        document.getElementById("memberEmail").innerText = user.email;
        currentUserId = user.uid;

        // Load member data
        const docRef = doc(db, "members", user.uid);
        const snap = await getDoc(docRef);
        if (snap.exists()) {
          const data = snap.data();
          document.getElementById("memberName").innerText = data.name || "No Name";
          if (data.photoURL) {
            document.getElementById("profilePhoto").src = data.photoURL;
          }
        }

        // Load progress
        const progressRef = collection(db, "members", user.uid, "progress");
        onSnapshot(progressRef, (snapshot) => {
          const list = document.getElementById("progressList");
          list.innerHTML = "";
          snapshot.forEach((docSnap) => {
            const li = document.createElement("li");
            li.textContent = docSnap.data().text;
            const delBtn = document.createElement("button");
            delBtn.textContent = "âŒ";
            delBtn.classList.add("ml-2", "text-red-500");
            delBtn.onclick = async () => await deleteDoc(doc(db, "members", user.uid, "progress", docSnap.id));
            li.appendChild(delBtn);
            list.appendChild(li);
          });
        });

        // Build downline tree
        document.getElementById("downlineTree").innerHTML = "";
        await buildTree(user.uid, document.getElementById("downlineTree"));

      } else {
        window.location.href = "index.html";
      }
    });

    // Add progress
    document.getElementById("progressForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const text = document.getElementById("progressInput").value.trim();
      if (!text || !currentUserId) return;
      await addDoc(collection(db, "members", currentUserId, "progress"), { text });
      document.getElementById("progressInput").value = "";
    });

    // Reset password
    document.getElementById("resetPasswordBtn").addEventListener("click", async () => {
      const user = auth.currentUser;
      if (user && user.email) {
        try {
          await sendPasswordResetEmail(auth, user.email);
          alert("Password reset email sent to " + user.email);
        } catch (err) {
          alert("Error sending reset email: " + err.message);
        }
      }
    });

    // Logout
    document.getElementById("logoutBtn").addEventListener("click", async () => {
      await signOut(auth);
    });
  </script>
</body>
</html>
