<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Member Dashboard - LITA Foundation</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    .dashboard { max-width: 800px; margin: 30px auto; background: #fff; padding: 20px; border-radius: 12px; }
    table { width: 100%; border-collapse: collapse; }
    td { padding: 8px; border-bottom: 1px solid #eee; }
    .avatar { width: 120px; height: 120px; border-radius: 50%; object-fit: cover; background: #f2f2f2; display: block; margin-bottom: 10px; }
    .photo-box { display:flex; align-items:center; gap:16px; }
    .history { list-style: none; padding-left: 0; }
    .history li { padding: 8px 0; border-bottom: 1px solid #eee; }
  </style>
</head>
<body>
  <div class="dashboard">
    <h2>Member Dashboard</h2>
    <button class="logout-btn" id="logout">Logout</button>

    <h3>Your Details</h3>
    <div class="photo-box">
      <img id="profilePreview" class="avatar" alt="Profile Photo" />
      <div>
        <input type="file" id="profileFile" accept="image/*" />
        <button id="savePhoto">Save Photo</button>
        <div id="photoMsg"></div>
      </div>
    </div>

    <table id="userDetailsTable">
      <tbody></tbody>
    </table>

    <h3>Update Business Progress</h3>
    <form id="progressForm">
      <input type="text" id="businessProgress" placeholder="Enter your progress" required />
      <button type="submit">Update Progress</button>
      <div id="updateMessage"></div>
    </form>

    <h3>Progress History</h3>
    <ul id="progressHistory" class="history"></ul>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, updateDoc, collection, addDoc, serverTimestamp, query, orderBy, getDocs
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAMnu2djtDKXMrTVKnppeCfKXRCy1KkEYk",
      authDomain: "lita-platform-bffdc.firebaseapp.com",
      projectId: "lita-platform-bffdc",
      storageBucket: "lita-platform-bffdc.appspot.com",
      messagingSenderId: "387943226211",
      appId: "1:387943226211:web:0127c409e0f880df391156"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let memberDocRef = null;
    let currentUid = null;

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = "signin.html";
        return;
      }
      currentUid = user.uid;
      memberDocRef = doc(db, "members", currentUid);
      await loadMemberData();
      await loadProgressHistory();
    });

    async function loadMemberData() {
      const m = await getDoc(memberDocRef);
      if (!m.exists()) return;
      const data = m.data();

      // profile photo
      const preview = document.getElementById("profilePreview");
      preview.src = data.profilePhoto || "";
      preview.style.display = data.profilePhoto ? "block" : "none";

      const tbody = document.querySelector("#userDetailsTable tbody");
      tbody.innerHTML = `
        <tr><td>Member ID</td><td>${data.memberId || ""}</td></tr>
        <tr><td>Full Name</td><td>${data.fullName || ""}</td></tr>
        <tr><td>Email</td><td>${data.email || ""}</td></tr>
        <tr><td>Phone</td><td>${data.phone || ""}</td></tr>
        <tr><td>Gender</td><td>${data.gender || ""}</td></tr>
        <tr><td>Location</td><td>${data.location || ""}</td></tr>
        <tr><td>Upline ID</td><td>${data.upline || ""}</td></tr>
        <tr><td>Current Business Progress</td><td>${data.businessProgress || "N/A"}</td></tr>
      `;
    }

    async function loadProgressHistory() {
      const histQ = query(collection(db, "members", currentUid, "progressHistory"), orderBy("timestamp", "desc"));
      const snap = await getDocs(histQ);
      const list = document.getElementById("progressHistory");
      list.innerHTML = "";
      snap.forEach((d) => {
        const p = d.data();
        const when = p.timestamp?.toDate().toLocaleString() || "(no time)";
        const li = document.createElement("li");
        li.textContent = `${when} — ${p.progress}`;
        list.appendChild(li);
      });
    }

    // Save progress
    document.getElementById("progressForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const progress = document.getElementById("businessProgress").value.trim();
      const msg = document.getElementById("updateMessage");
      msg.textContent = "";

      try {
        await updateDoc(memberDocRef, { businessProgress: progress });
        await addDoc(collection(db, "members", currentUid, "progressHistory"), {
          progress,
          timestamp: serverTimestamp()
        });
        msg.textContent = "✅ Progress updated successfully!";
        e.target.reset();
        await loadMemberData();
        await loadProgressHistory();
      } catch (err) {
        msg.textContent = "❌ " + err.message;
      }
    });

    // Profile photo: store as Base64 in Firestore
    const toDataURL = (file) =>
      new Promise((resolve, reject) => {
        const r = new FileReader();
        r.onload = () => resolve(r.result);
        r.onerror = reject;
        r.readAsDataURL(file);
      });

    document.getElementById("savePhoto").addEventListener("click", async () => {
      const fileInput = document.getElementById("profileFile");
      const msg = document.getElementById("photoMsg");
      msg.textContent = "";
      if (!fileInput.files || !fileInput.files[0]) {
        msg.textContent = "❌ Please choose an image first.";
        return;
      }
      try {
        const dataUrl = await toDataURL(fileInput.files[0]);
        await updateDoc(memberDocRef, { profilePhoto: dataUrl });
        msg.textContent = "✅ Photo saved!";
        document.getElementById("profilePreview").src = dataUrl;
        document.getElementById("profilePreview").style.display = "block";
        fileInput.value = "";
      } catch (err) {
        msg.textContent = "❌ " + err.message;
      }
    });

    document.getElementById("logout").addEventListener("click", () => signOut(auth).then(() => (window.location.href = "signin.html")));
  </script>
</body>
</html>
