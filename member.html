<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>LITA Member Dashboard</title>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    ul { list-style-type: none; padding-left: 20px; }
    li { margin: 10px 0; }
  </style>
</head>
<body class="bg-gray-100 p-6">
  <h1 class="text-2xl font-bold mb-4">Member Dashboard - LITA Foundation Uganda</h1>

  <!-- Profile -->
  <div id="profile" class="bg-white p-4 rounded shadow mb-6"></div>

  <!-- Progress History -->
  <div class="bg-white p-4 rounded shadow mb-6">
    <h2 class="text-xl font-semibold mb-2">Progress History</h2>
    <ul id="progressList"></ul>
  </div>

  <!-- My Tree -->
  <div class="bg-white p-4 rounded shadow">
    <h2 class="text-xl font-semibold mb-2">My Downline Tree</h2>
    <ul id="myTreeView"></ul>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAMnu2djtDKXMrTVKnppeCfKXRCy1KkEYk",
      authDomain: "lita-platform-bffdc.firebaseapp.com",
      projectId: "lita-platform-bffdc",
      storageBucket: "lita-platform-bffdc.appspot.com",
      messagingSenderId: "387943226211",
      appId: "1:387943226211:web:0127c409e0f880df391156"
    };

    const app = firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let currentId = null;

    auth.onAuthStateChanged(async (user) => {
      if (user) {
        const snapshot = await db.collection("members").where("email", "==", user.email).get();
        if (!snapshot.empty) {
          const data = snapshot.docs[0].data();
          currentId = data.idNumber;
          document.getElementById("profile").innerHTML = `
            <div class="flex items-center">
              <img src="${data.photoUrl}" class="w-16 h-16 rounded-full mr-4"/>
              <div>
                <p class="font-bold">${data.name}</p>
                <p>ID: ${data.idNumber}</p>
                <p>Email: ${data.email}</p>
              </div>
            </div>
          `;
          let progressHTML = "";
          (data.progress || []).forEach(p => {
            progressHTML += `<li class="border-b py-1">${p.date}: ${p.note}</li>`;
          });
          document.getElementById("progressList").innerHTML = progressHTML;

          showMyTree(currentId, data);
        }
      }
    });

    async function buildTree(memberId) {
      const snapshot = await db.collection("members").where("uplineId", "==", memberId).get();
      let children = [];
      for (const doc of snapshot.docs) {
        const data = doc.data();
        children.push({
          idNumber: data.idNumber,
          name: data.name,
          photoUrl: data.photoUrl || "",
          children: await buildTree(data.idNumber)
        });
      }
      return children;
    }

    function renderTree(node, container) {
      let li = document.createElement("li");
      li.innerHTML = `
        <div class="p-2 shadow rounded bg-white inline-flex items-center">
          <img src="${node.photoUrl}" class="w-12 h-12 rounded-full mr-2"/>
          <span class="font-bold">${node.name}</span> <small>(${node.idNumber})</small>
        </div>
      `;
      if (node.children && node.children.length > 0) {
        let ul = document.createElement("ul");
        node.children.forEach(child => renderTree(child, ul));
        li.appendChild(ul);
      }
      container.appendChild(li);
    }

    async function showMyTree(myId, data) {
      const rootNode = {
        idNumber: data.idNumber,
        name: data.name,
        photoUrl: data.photoUrl || "",
        children: await buildTree(data.idNumber)
      };
      let container = document.getElementById("myTreeView");
      container.innerHTML = "";
      renderTree(rootNode, container);
    }
  </script>
</body>
</html>
