<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Member Dashboard</title>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
  <script>emailjs.init("hZgalRaZwSRy1Zgp4");</script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .profile, .progress, .tree, .actions { margin-bottom: 20px; padding: 15px; border: 1px solid #ccc; border-radius: 8px; }
    img { width: 60px; height: 60px; border-radius: 50%; }
    ul { list-style-type: none; padding-left: 20px; }
    li { margin: 5px 0; }
    .node { display: flex; align-items: center; gap: 8px; }
  </style>
</head>
<body>
  <h2>Member Dashboard</h2>

  <div class="profile">
    <h3>Profile</h3>
    <img id="profilePhoto" src="" alt="Profile Photo"/>
    <p><strong>Name:</strong> <span id="profileName"></span></p>
    <p><strong>Email:</strong> <span id="profileEmail"></span></p>
    <p><strong>Phone:</strong> <span id="profilePhone"></span></p>
    <p><strong>Location:</strong> <span id="profileLocation"></span></p>
    <p><strong>Member ID:</strong> <span id="profileId"></span></p>
    <button onclick="sendReset()">Reset Password</button>
  </div>

  <div class="progress">
    <h3>Business Progress</h3>
    <form id="progressForm">
      <input type="text" id="progressInput" placeholder="Enter progress update" required>
      <button type="submit">Submit</button>
    </form>
    <ul id="progressList"></ul>
  </div>

  <div class="tree">
    <h3>My Downline</h3>
    <ul id="treeRoot"></ul>
  </div>

  <div class="actions">
    <button onclick="logout()">Logout</button>
  </div>

<script>
  // Firebase Config
  const firebaseConfig = {
    apiKey: "AIzaSyAMnu2djtDKXMrTVKnppeCfKXRCy1KkEYk",
    authDomain: "lita-platform-bffdc.firebaseapp.com",
    projectId: "lita-platform-bffdc",
    storageBucket: "lita-platform-bffdc.firebasestorage.app",
    messagingSenderId: "387943226211",
    appId: "1:387943226211:web:0127c409e0f880df391156"
  };
  const app = firebase.initializeApp(firebaseConfig);
  const auth = firebase.getAuth(app);
  const db = firebase.getFirestore(app);

  let currentMemberId = null;
  let currentEmail = null;

  firebase.onAuthStateChanged(auth, async (user) => {
    if (!user) { window.location.href = "index.html"; return; }
    currentEmail = user.email;
    const snap = await firebase.getDocs(
      firebase.query(firebase.collection(db,"members"), firebase.where("email","==",currentEmail))
    );
    if (!snap.empty) {
      const d = snap.docs[0].data();
      currentMemberId = d.memberId;
      document.getElementById("profilePhoto").src = d.photoURL || "https://ui-avatars.com/api/?name="+encodeURIComponent(d.fullName);
      document.getElementById("profileName").textContent = d.fullName;
      document.getElementById("profileEmail").textContent = d.email;
      document.getElementById("profilePhone").textContent = d.phone;
      document.getElementById("profileLocation").textContent = d.location;
      document.getElementById("profileId").textContent = d.memberId;
      loadProgress();
      buildAndRenderTree();
    }
  });

  // Add progress
  document.getElementById("progressForm").addEventListener("submit", async (e)=>{
    e.preventDefault();
    const txt = document.getElementById("progressInput").value;
    await firebase.addDoc(firebase.collection(db,"progress"),{
      memberId: currentMemberId, text: txt, createdAt: new Date()
    });
    document.getElementById("progressInput").value="";
    loadProgress();
  });

  async function loadProgress(){
    const q = firebase.query(
      firebase.collection(db,"progress"),
      firebase.where("memberId","==",currentMemberId),
      firebase.orderBy("createdAt","desc")
    );
    const snaps = await firebase.getDocs(q);
    const list = document.getElementById("progressList");
    list.innerHTML="";
    snaps.forEach(doc=>{
      const li = document.createElement("li");
      li.textContent = doc.data().text+" ("+doc.data().createdAt.toDate().toLocaleString()+")";
      list.appendChild(li);
    });
  }

  // Downline Tree Recursive
  async function fetchChildren(uplineId){
    const res=[];
    const q = firebase.query(firebase.collection(db,"members"), firebase.where("uplineId","==",uplineId));
    const snaps=await firebase.getDocs(q);
    for(const doc of snaps.docs){
      const d = doc.data();
      res.push({
        memberId: d.memberId,
        fullName: d.fullName,
        photoURL: d.photoURL||"",
        children: await fetchChildren(d.memberId)
      });
    }
    return res;
  }

  async function buildAndRenderTree(){
    const root=document.getElementById("treeRoot");
    root.innerHTML="";
    const nodes=await fetchChildren(currentMemberId);
    function render(nodes,parent){
      nodes.forEach(n=>{
        const li=document.createElement("li");
        const img=n.photoURL||("https://ui-avatars.com/api/?name="+encodeURIComponent(n.fullName));
        li.innerHTML=`<div class="node"><img src="${img}"><span>${n.fullName} <strong>${n.memberId}</strong></span></div>`;
        parent.appendChild(li);
        if(n.children.length){
          const ul=document.createElement("ul");
          li.appendChild(ul);
          render(n.children,ul);
        }
      });
    }
    render(nodes,root);
  }

  // Password Reset (via EmailJS)
  async function sendReset(){
    if(!currentEmail||!currentMemberId) return;
    const tempPass = Math.random().toString(36).slice(-8);
    // update Firestore with new password
    const q = firebase.query(firebase.collection(db,"members"), firebase.where("email","==",currentEmail));
    const snaps = await firebase.getDocs(q);
    if(!snaps.empty){
      await firebase.updateDoc(snaps.docs[0].ref,{ tempPassword: tempPass });
    }
    // send Email
    await emailjs.send("service_mrqs34o","template_svacje4",{
      to_email: currentEmail,
      to_name: document.getElementById("profileName").textContent,
      temp_password: tempPass,
      member_id: currentMemberId
    });
    alert("Password reset email sent with new temporary password!");
  }

  function logout(){ firebase.signOut(auth); }
</script>
</body>
</html>
