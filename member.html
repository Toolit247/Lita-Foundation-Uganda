<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Member Dashboard - LITA Foundation Uganda</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Firebase v8 to match the rest -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
  <style>
    :root{--bg:#f6f7fb;--card:#fff;--text:#1f2937;--muted:#6b7280;--brand:#2563eb;--border:#e5e7eb;--ok:#16a34a;--err:#dc2626}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);font-family:Inter,system-ui,Arial,sans-serif;color:var(--text)}
    header{display:flex;justify-content:space-between;align-items:center;padding:14px 18px;background:var(--card);border-bottom:1px solid var(--border)}
    .container{max-width:900px;margin:18px auto;padding:0 14px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px;box-shadow:0 4px 16px rgba(0,0,0,.03)}
    h2,h3{margin:0 0 10px}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    input,button{padding:11px;border:1px solid var(--border);border-radius:10px;font:inherit}
    input{width:100%}
    .btn{background:var(--brand);color:#fff;border:none;cursor:pointer;font-weight:600}
    .btn.outline{background:#eef2ff;color:#111}
    .msg{margin-top:8px;font-weight:600}
    .ok{color:var(--ok)} .err{color:var(--err)}
    .avatar{width:84px;height:84px;border-radius:50%;object-fit:cover;border:1px solid var(--border)}
    ul.tree, ul.tree ul{list-style:none;margin-left:0;padding-left:18px}
    ul.tree li{margin:6px 0}
    .node{display:inline-flex;gap:8px;align-items:center;background:#fff;border:1px solid var(--border);border-radius:10px;padding:6px 10px;box-shadow:0 2px 10px rgba(0,0,0,.03);cursor:pointer}
    .node img{width:28px;height:28px;border-radius:50%;object-fit:cover;border:1px solid var(--border)}
    table{width:100%;border-collapse:collapse}
    td{padding:8px;border-bottom:1px solid var(--border)}
    .tag{margin-left:6px;color:#1d4ed8;background:#eef2ff;padding:0 6px;border-radius:999px}
    .item{display:flex;justify-content:space-between;align-items:center;border:1px solid var(--border);border-radius:10px;padding:8px 10px;background:#fff;margin:8px 0}
    .muted{color:#6b7280;font-size:12px}
    .btn.small{padding:6px 8px;border-radius:8px}
    .btn.warn{background:#f59e0b;color:#fff;border:1px solid #f59e0b}
    .btn.danger{background:#dc2626;color:#fff;border:1px solid #dc2626}
    .caret{display:inline-block;transform:rotate(90deg);transition:.15s; font-size:12px; color:#6b7280; margin-right:6px}
    .collapsed .caret{transform:rotate(0deg)}
  </style>
</head>
<body>
<header>
  <div><strong>LITA • Member Dashboard</strong></div>
  <div class="row">
    <button id="resetPwd" class="btn outline">Reset Password</button>
    <button id="logout" class="btn">Logout</button>
  </div>
</header>

<div class="container">
  <!-- Profile -->
  <section class="card">
    <h3>Your Profile</h3>
    <div class="row" style="align-items:center">
      <img id="avatar" class="avatar" src="https://ui-avatars.com/api/?background=E5E7EB&color=111&name=LITA" alt="">
      <div id="profileText"></div>
    </div>
    <div class="row" style="margin-top:10px">
      <input type="file" id="photoFile" accept="image/*" />
      <button id="uploadPhoto" class="btn">Upload Photo</button>
    </div>
    <div id="photoMsg" class="msg"></div>
  </section>

  <!-- Update Business Progress -->
  <section class="card" style="margin-top:14px">
    <h3>Update Business Progress</h3>
    <form id="progressForm" class="row">
      <input type="text" id="businessProgress" placeholder="Enter your progress" required />
      <button type="submit" class="btn">Update</button>
    </form>
    <div id="updateMessage" class="msg"></div>
  </section>

  <!-- Progress history (editable) -->
  <section class="card" style="margin-top:14px">
    <h3>Progress History</h3>
    <div id="progressHistory"></div>
  </section>

  <!-- Downline tree -->
  <section class="card" style="margin-top:14px">
    <h3>Your Downline</h3>
    <p class="muted" style="margin:6px 0 10px">Click a node to expand/collapse.</p>
    <ul id="treeRoot" class="tree"></ul>
  </section>
</div>

<script>
  // Firebase v8
  var firebaseConfig = {
    apiKey: "AIzaSyAMnu2djtDKXMrTVKnppeCfKXRCy1KkEYk",
    authDomain: "lita-platform-bffdc.firebaseapp.com",
    projectId: "lita-platform-bffdc",
    storageBucket: "lita-platform-bffdc.appspot.com",
    messagingSenderId: "387943226211",
    appId: "1:387943226211:web:0127c409e0f880df391156"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const storage = firebase.storage();

  let memberDocRef = null;
  let myMemberId = "";

  // Auth guard + load
  firebase.auth().onAuthStateChanged(async (user)=>{
    if(!user){ window.location.href="signin.html"; return; }
    const doc = await db.collection("members").doc(user.uid).get();
    if(!doc.exists){
      await firebase.auth().signOut();
      alert("Access denied: not registered as a member.");
      window.location.href="signin.html";
      return;
    }
    memberDocRef = doc.ref;
    const d = doc.data();
    myMemberId = d.memberId || "";
    renderProfile(d);
    await loadProgressHistory();
    buildAndRenderTree();
  });

  function renderProfile(d){
    const avatar = document.getElementById("avatar");
    avatar.src = d.photoURL || ("https://ui-avatars.com/api/?background=E5E7EB&color=111&name=" + encodeURIComponent(d.fullName||"LITA"));
    document.getElementById("profileText").innerHTML = `
      <table>
        <tr><td><strong>Name</strong></td><td>${d.fullName||""}</td></tr>
        <tr><td><strong>Email</strong></td><td>${d.email||""}</td></tr>
        <tr><td><strong>Member ID</strong></td><td>${d.memberId||""}</td></tr>
        <tr><td><strong>Upline</strong></td><td>${d.upline||""}</td></tr>
        <tr><td><strong>Phone</strong></td><td>${d.phone||""}</td></tr>
        <tr><td><strong>Gender</strong></td><td>${d.gender||""}</td></tr>
        <tr><td><strong>Location</strong></td><td>${d.location||""}</td></tr>
        <tr><td><strong>Current Progress</strong></td><td>${d.businessProgress||"N/A"}</td></tr>
      </table>
    `;
  }

  // Photo upload (members only)
  document.getElementById("uploadPhoto").addEventListener("click", async ()=>{
    const file = document.getElementById("photoFile").files[0];
    const msg = document.getElementById("photoMsg");
    msg.textContent = ""; msg.className="msg";
    if(!file){ msg.textContent="❌ Please select an image."; msg.classList.add("err"); return; }
    try{
      const uid = firebase.auth().currentUser.uid;
      const ref = storage.ref(`member_photos/${uid}/${Date.now()}_${file.name}`);
      await ref.put(file);
      const url = await ref.getDownloadURL();
      await memberDocRef.update({ photoURL:url });
      msg.textContent = "✅ Photo uploaded.";
      msg.classList.add("ok");
      const d = (await memberDocRef.get()).data();
      renderProfile(d);
    }catch(e){
      msg.textContent = "❌ " + e.message;
      msg.classList.add("err");
    }
  });

  // Update progress + history
  document.getElementById("progressForm").addEventListener("submit", async (e)=>{
    e.preventDefault();
    const progress = document.getElementById("businessProgress").value.trim();
    const updateMsg = document.getElementById("updateMessage");
    updateMsg.textContent=""; updateMsg.className="msg";
    try{
      // Set current progress on profile
      await memberDocRef.update({ businessProgress: progress });
      // Add to history
      await memberDocRef.collection("progressHistory").add({
        progress,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      });
      document.getElementById("businessProgress").value="";
      updateMsg.textContent="✅ Progress updated.";
      updateMsg.classList.add("ok");
      await loadProgressHistory();
      const d = (await memberDocRef.get()).data();
      renderProfile(d);
    }catch(e){
      updateMsg.textContent="❌ " + e.message;
      updateMsg.classList.add("err");
    }
  });

  // Render editable history list
  async function loadProgressHistory(){
    const snap = await memberDocRef.collection("progressHistory").orderBy("timestamp","desc").get();
    const container = document.getElementById("progressHistory");
    container.innerHTML = "";
    snap.forEach(doc=>{
      const d = doc.data();
      const time = (d.timestamp && d.timestamp.toDate) ? d.timestamp.toDate().toLocaleString() : "—";
      const row = document.createElement("div");
      row.className = "item";
      row.innerHTML = `
        <div>
          <div><strong>${(d.progress||"")}</strong></div>
          <div class="muted">${time}</div>
        </div>
        <div class="row">
          <button class="btn small warn" data-edit="${doc.id}">Edit</button>
          <button class="btn small danger" data-del="${doc.id}">Delete</button>
        </div>
      `;
      container.appendChild(row);
    });
  }

  // Edit/Delete handlers for history
  document.getElementById("progressHistory").addEventListener("click", async (e)=>{
    const delId = e.target.getAttribute("data-del");
    const editId = e.target.getAttribute("data-edit");

    async function recomputeLatestToProfile(){
      const q = await memberDocRef.collection("progressHistory").orderBy("timestamp","desc").limit(1).get();
      const latest = q.empty ? "" : (q.docs[0].data().progress||"");
      await memberDocRef.update({ businessProgress: latest });
      const d = (await memberDocRef.get()).data();
      renderProfile(d);
    }

    if(delId){
      if(!confirm("Delete this progress entry?")) return;
      try{
        await memberDocRef.collection("progressHistory").doc(delId).delete();
        await recomputeLatestToProfile();
        await loadProgressHistory();
      }catch(err){ alert(err.message); }
    }

    if(editId){
      const curSnap = await memberDocRef.collection("progressHistory").doc(editId).get();
      const cur = (curSnap.exists && curSnap.data().progress) ? curSnap.data().progress : "";
      const newVal = prompt("Update progress:", cur);
      if(!newVal || !newVal.trim()) return;
      try{
        await memberDocRef.collection("progressHistory").doc(editId).update({ progress:newVal.trim() });
        await recomputeLatestToProfile();
        await loadProgressHistory();
      }catch(err){ alert(err.message); }
    }
  });

  // Password reset (sends email to logged-in member)
  document.getElementById("resetPwd").addEventListener("click", async ()=>{
    const user = firebase.auth().currentUser;
    if(!user || !user.email){ alert("No email found for your account."); return; }
    try{
      await firebase.auth().sendPasswordResetEmail(user.email);
      alert("Password reset email sent.");
    }catch(e){ alert(e.message); }
  });

  // Logout
  document.getElementById("logout").addEventListener("click", ()=>{
    firebase.auth().signOut().then(()=> window.location.href="signin.html");
  });

  // -------- Downline tree (based on your Member ID as upline) with collapse --------
  async function fetchChildren(uplineId) {
    const snap = await db.collection("members").where("upline","==",uplineId).get();
    const res = [];
    for (const doc of snap.docs) {
      const d = doc.data();
      res.push({
        id: doc.id,
        fullName: d.fullName||"",
        memberId: d.memberId||"",
        photoURL: d.photoURL||"",
        children: await fetchChildren(d.memberId||"")
      });
    }
    return res;
  }

  function renderTreeNode(node, ul) {
    const li = document.createElement("li");
    li.className = "collapsed";
    const img = node.photoURL || "https://ui-avatars.com/api/?background=E5E7EB&color=111&name=" + encodeURIComponent(node.fullName||"LITA");
    const nodeDiv = document.createElement("div");
    nodeDiv.className = "node";
    nodeDiv.innerHTML = `
      <span class="caret">▶</span>
      <img src="${img}" alt="">
      <div><strong>${node.fullName}</strong> <span class="tag">${node.memberId}</span></div>
    `;
    li.appendChild(nodeDiv);

    let sub = null;
    if (node.children && node.children.length) {
      sub = document.createElement("ul");
      sub.className="tree";
      node.children.forEach(ch => renderTreeNode(ch, sub));
      sub.style.display = "none"; // start collapsed
      li.appendChild(sub);
    }

    nodeDiv.addEventListener("click", ()=>{
      if(!sub) return;
      const isHidden = sub.style.display === "none";
      sub.style.display = isHidden ? "block" : "none";
      li.classList.toggle("collapsed", !isHidden);
    });

    ul.appendChild(li);
  }

  async function buildAndRenderTree(){
    const rootEl = document.getElementById("treeRoot");
    rootEl.innerHTML = "";
    if(!myMemberId) { rootEl.innerHTML = "<li>No Member ID found.</li>"; return; }
    const profile = (await memberDocRef.get()).data();
    const root = { fullName: "Me", memberId: myMemberId, photoURL: profile.photoURL||"", children: await fetchChildren(myMemberId) };
    renderTreeNode(root, rootEl);
  }
</script>
</body>
</html>
