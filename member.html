<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Member Dashboard - LITA Foundation Uganda</title>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background: #f8f9fa; margin:0; padding:0; }
    header { background:#2c3e50; color:white; padding:15px; text-align:center; }
    main { padding:20px; max-width:1000px; margin:auto; }
    section { background:white; border-radius:10px; padding:20px; margin-bottom:20px; box-shadow:0 2px 5px rgba(0,0,0,0.1);}
    h2 { color:#2c3e50; }
    label { display:block; margin-top:10px; font-weight:bold; }
    input, textarea, button { width:100%; padding:10px; margin-top:5px; border:1px solid #ccc; border-radius:5px; }
    button { background:#27ae60; color:white; font-weight:bold; cursor:pointer; margin-top:8px; }
    button:hover { background:#219150; }
    ul { list-style:none; padding-left:20px; }
    .tree li { margin:5px 0; }
    .logout-btn { background:#e74c3c; }
    .action-btn { width:auto; margin-left:10px; padding:5px 10px; font-size:0.9em; }
    .detail-row { margin:4px 0; }
    .detail-label { font-weight:bold; color:#34495e; margin-right:8px; }
  </style>
</head>
<body>
  <header>
    <h1>Member Dashboard</h1>
  </header>
  <main>
    <!-- Profile Section -->
    <section>
      <h2>My Profile</h2>
      <img id="profile-photo" src="" alt="Profile Photo" width="120" style="border-radius:50%; display:block; margin-bottom:10px;">
      <input type="file" id="photoUpload">

      <div class="detail-row"><span class="detail-label">Name:</span><span id="profile-name"></span></div>
      <div class="detail-row"><span class="detail-label">Email:</span><span id="profile-email"></span></div>
      <div class="detail-row"><span class="detail-label">Member ID:</span><span id="profile-memberId"></span></div>
      <div class="detail-row"><span class="detail-label">Upline:</span><span id="profile-upline"></span></div>
      <div class="detail-row"><span class="detail-label">Date Joined:</span><span id="profile-date"></span></div>
    </section>

    <!-- Change Password -->
    <section>
      <h2>Change Password</h2>
      <label>Current Password</label>
      <input type="password" id="currentPassword">
      <label>New Password</label>
      <input type="password" id="newPassword">
      <label>Confirm New Password</label>
      <input type="password" id="confirmPassword">
      <button onclick="changePassword()">Update Password</button>
    </section>

    <!-- Progress History -->
    <section>
      <h2>Business Progress</h2>
      <textarea id="progressInput" placeholder="Enter your progress update..."></textarea>
      <button onclick="addProgress()">Add Progress</button>
      <ul id="progressList"></ul>
    </section>

    <!-- Downline Tree -->
    <section>
      <h2>My Downline</h2>
      <ul id="downlineTree" class="tree"></ul>
    </section>

    <button class="logout-btn" onclick="logout()">Logout</button>
  </main>

  <script>
    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyAMnu2djtDKXMrTVKnppeCfKXRCy1KkEYk",
      authDomain: "lita-platform-bffdc.firebaseapp.com",
      projectId: "lita-platform-bffdc",
      storageBucket: "lita-platform-bffdc.appspot.com",
      messagingSenderId: "387943226211",
      appId: "1:387943226211:web:0127c409e0f880df391156",
      measurementId: "G-44JEYP8ZHD"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const storage = firebase.storage();

    let currentUser;

    auth.onAuthStateChanged(user => {
      if (!user) {
        window.location.href = "index.html";
        return;
      }
      currentUser = user;
      loadProfile();
      loadProgress();
      loadDownline(user.uid);
    });

    // Load Profile
    async function loadProfile() {
      document.getElementById("profile-email").innerText = currentUser.email;
      const snap = await db.collection("members").doc(currentUser.uid).get();
      if (snap.exists) {
        const data = snap.data();
        document.getElementById("profile-name").innerText = data.fullName || "Not set";
        document.getElementById("profile-memberId").innerText = data.memberId || "-";
        document.getElementById("profile-upline").innerText = data.upline || "-";
        document.getElementById("profile-date").innerText = data.createdAt?.toDate().toLocaleDateString() || "-";
        if (data.photoURL) document.getElementById("profile-photo").src = data.photoURL;
      }
      document.getElementById("photoUpload").addEventListener("change", uploadPhoto);
    }

    async function uploadPhoto(e) {
      const file = e.target.files[0];
      if (!file) return;
      const ref = storage.ref("profile_photos/" + currentUser.uid);
      await ref.put(file);
      const url = await ref.getDownloadURL();
      await db.collection("members").doc(currentUser.uid).update({ photoURL: url });
      document.getElementById("profile-photo").src = url;
    }

    // Change Password
    async function changePassword() {
      const currentPass = document.getElementById("currentPassword").value;
      const newPass = document.getElementById("newPassword").value;
      const confirmPass = document.getElementById("confirmPassword").value;

      if (newPass !== confirmPass) {
        alert("Passwords do not match!");
        return;
      }

      const credential = firebase.auth.EmailAuthProvider.credential(currentUser.email, currentPass);
      try {
        await currentUser.reauthenticateWithCredential(credential);
        await currentUser.updatePassword(newPass);
        alert("Password updated successfully!");
      } catch (err) {
        alert("Error: " + err.message);
      }
    }

    // Progress History
    async function addProgress() {
      const text = document.getElementById("progressInput").value;
      if (!text) return;
      await db.collection("progress").add({
        uid: currentUser.uid,
        text,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      });
      document.getElementById("progressInput").value = "";
      loadProgress();
    }

    async function loadProgress() {
      const list = document.getElementById("progressList");
      list.innerHTML = "";
      const snap = await db.collection("progress").where("uid","==",currentUser.uid).orderBy("timestamp","desc").get();
      snap.forEach(doc => {
        const data = doc.data();
        const li = document.createElement("li");
        li.textContent = `${data.text} (${data.timestamp?.toDate().toLocaleString() || ""})`;

        // Edit button
        const edit = document.createElement("button");
        edit.textContent = "Edit";
        edit.className = "action-btn";
        edit.onclick = async () => {
          const newText = prompt("Edit your progress:", data.text);
          if (newText) {
            await db.collection("progress").doc(doc.id).update({ text: newText });
            loadProgress();
          }
        };

        // Delete button
        const del = document.createElement("button");
        del.textContent = "Delete";
        del.className = "action-btn";
        del.onclick = async () => {
          if (confirm("Delete this progress update?")) {
            await db.collection("progress").doc(doc.id).delete();
            loadProgress();
          }
        };

        li.appendChild(edit);
        li.appendChild(del);
        list.appendChild(li);
      });
    }

    // Recursive Downline
    async function loadDownline(uid, element=document.getElementById("downlineTree")) {
      const snap = await db.collection("members").where("upline","==",uid).get();
      snap.forEach(doc => {
        const li = document.createElement("li");
        const data = doc.data();
        li.textContent = `${data.fullName || "Unnamed"} (${data.memberId || "-"})`;
        const childUl = document.createElement("ul");
        li.appendChild(childUl);
        element.appendChild(li);
        loadDownline(doc.id, childUl);
      });
    }

    // Logout
    function logout() {
      auth.signOut();
    }
  </script>
</body>
</html>
