<script>
  var firebaseConfig = {
    apiKey: "AIzaSyAMnu2djtDKXMrTVKnppeCfKXRCy1KkEYk",
    authDomain: "lita-platform-bffdc.firebaseapp.com",
    projectId: "lita-platform-bffdc",
    storageBucket: "lita-platform-bffdc.appspot.com",
    messagingSenderId: "387943226211",
    appId: "1:387943226211:web:0127c409e0f880df391156"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  let memberDocRef;

  firebase.auth().onAuthStateChanged(user => {
    if (!user) {
      window.location.href = "signin.html";
    } else {
      loadMemberData(user.email);
    }
  });

  function loadMemberData(email) {
    db.collection("members").where("email", "==", email).get()
      .then(querySnapshot => {
        const tbody = document.querySelector("#userDetailsTable tbody");
        tbody.innerHTML = "";
        querySnapshot.forEach(doc => {
          const data = doc.data();
          memberDocRef = doc.ref;
          tbody.innerHTML += `
            <tr><td>Full Name</td><td>${data.fullName}</td></tr>
            <tr><td>Email</td><td>${data.email}</td></tr>
            <tr><td>Phone</td><td>${data.phone}</td></tr>
            <tr><td>Gender</td><td>${data.gender}</td></tr>
            <tr><td>Location</td><td>${data.location}</td></tr>
            <tr><td>Upline ID</td><td>${data.upline}</td></tr>
            <tr><td>Current Business Progress</td><td>${data.businessProgress || 'N/A'}</td></tr>
          `;
          loadProgressHistory(doc.ref);
        });
      });
  }

  function loadProgressHistory(docRef) {
    docRef.collection("progressHistory").orderBy("timestamp", "desc").get()
      .then(snapshot => {
        const historyList = document.getElementById("progressHistory");
        historyList.innerHTML = "";
        snapshot.forEach(doc => {
          const data = doc.data();
          const listItem = document.createElement("li");
          listItem.textContent = `${data.timestamp.toDate().toLocaleString()} - ${data.progress}`;
          historyList.appendChild(listItem);
        });
      });
  }

  document.getElementById("progressForm").addEventListener("submit", function(e) {
    e.preventDefault();
    const progress = document.getElementById("businessProgress").value;
    const timestamp = firebase.firestore.FieldValue.serverTimestamp();

    memberDocRef.update({ businessProgress: progress }).then(() => {
      memberDocRef.collection("progressHistory").add({ progress, timestamp }).then(() => {
        document.getElementById("updateMessage").textContent = "✅ Progress updated successfully!";
        loadProgressHistory(memberDocRef);
      });
    }).catch(err => {
      document.getElementById("updateMessage").textContent = "❌ Failed to update: " + err.message;
    });
  });

  document.getElementById("logout").addEventListener("click", () => {
    firebase.auth().signOut().then(() => window.location.href = "signin.html");
  });
</script>
